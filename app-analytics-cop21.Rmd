---
title: "COP21 Datapack App Analytics"
output:
  pdf_document: default
html_document:
  df_print: paged
lang: "en-US"
date: '`r format(Sys.time(), "%d %B, %Y %H:%M")`'
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(data.table)
require(magrittr)
require(purrr)
require(dplyr)
require(tidyr)
require(knitr)
require(ggplot2)
require(paws)
require(connectapi)
require(lubridate)
require(noctua)

#Connect to the Athena database
con <- dbConnect(noctua::athena())


Sys.setlocale("LC_MESSAGES", 'en_GB.UTF-8')
Sys.setenv(LANG = "en_US.UTF-8")

```


## Summary info
```{r summary_info, eval=TRUE, echo=FALSE}


d_validation_details <- dbGetQuery(con,"SELECT country_name,validation_issue_category, event_date,
SUM(count) as count FROM (
SELECT country_name,validation_issue_category,
CAST(date_parse(ts, '%Y-%m-%d %T') as date) as event_date,
count
FROM datapackr.app_analytics_new
)
GROUP BY country_name,validation_issue_category,event_date
ORDER BY event_date,country_name;")

d_validation_runs <- dbGetQuery(con,"SELECT  DISTINCT country_name,CAST(date_parse(ts, '%Y-%m-%d %T') as date) as event_date,
                                uuid FROM datapackr.app_analytics_new")

total_validations<-nrow(d_validation_runs)
start_date<-min(d_validation_runs$event_date)
end_date<-max(d_validation_runs$event_date)
```


- Total validations: `r total_validations`
- First validation on: `r start_date`
- Last validation on: `r end_date`

## Validations by country


```{r validations_by_country, eval=TRUE, echo=FALSE}
validations_by_country_total<-
d_validation_runs %>% 
  dplyr::select(Country=country_name,event_date) %>% 
  dplyr::group_by(Country) %>% 
  dplyr::summarise(Validations=n()) %>% 
  dplyr::arrange(-Validations)

kable(validations_by_country_total)
```

## Validations by day

```{r validations_by_date, eval=TRUE, echo=FALSE}

#Validations by date
validations_by_date_total<-
d_validation_runs %>% 
  dplyr::select(Date=event_date) %>% 
  dplyr::group_by(Date) %>% 
  dplyr::summarise(Validations = dplyr::n())

ggplot(validations_by_date_total,aes(x = Date, y= Validations)) + geom_col()


```


## Validation issues

```{r issue_summary, eval=TRUE, echo=FALSE}
#Issue summary

issue_summary<-d_validation_details%>% 
  dplyr::select(country_name,event_date,validation_issue_category) %>% 
  dplyr::group_by(validation_issue_category) %>% 
  dplyr::summarise(count=dplyr::n()) %>% 
  dplyr::arrange(-count) %>% 
  dplyr::mutate(occurrence_rate = ( (100*count/total_validations) %>% round(.,digits = 1)  ) ) %>% 
  dplyr::select(-count) %>% 
  dplyr::rename(Category = validation_issue_category,
                "Occurrence (%)" = occurrence_rate)


kable(issue_summary)
``` 


```{r shiny_load_data, eval=TRUE, echo=FALSE}


days_back <- as.numeric(Sys.getenv("DAYSBACK", 365))

default_content_title <- "Unknown (Deleted Content?)"

report_from <- lubridate::today() - lubridate::ddays(days_back)

client <- connectapi::connect()
shiny <- get_usage_shiny(
  client,
  from = report_from,
  limit = Inf
) %>%
  mutate(
    started = lubridate::ymd_hms(started),
    ended = lubridate::ymd_hms(ended),
    session_duration = ended - started
    ) %>%
  filter(session_duration > lubridate::dseconds(5))

content <- get_usage_static(
  client,
  from = report_from,
  limit = Inf
)

all_users <- get_users(client, page_size = 500)

data <-   list(shiny = shiny, content = content)
```


## Connect server stats
```{r shiny_over_time, eval=TRUE, echo=FALSE}
data$shiny %>%
    mutate(day = round_date(started, "day")) %>% 
    group_by(day) %>% 
    filter(day > today() - ddays(days_back)) %>% 
    summarise(visits = n()) %>% 
    arrange(desc(visits)) %>% 
    {ggplot(., aes(day, visits)) + 
            geom_bar(stat = "identity") + 
            labs(
                y = "# of Shiny Sessions",
                x = NULL
            )}
```


## Datapack sessions by day
```{r datapack_over_time, eval=FALSE, echo=FALSE}
data$shiny %>% 
      mutate(time = ymd_hms(started),
          day = round_date(started, "day")) %>% 
  dplyr::select(content_guid,time,day) %>% 
  group_by(content_guid,day) %>% 
  summarize(visits = n()) %>% 
  arrange(content_guid,desc(visits)) %>% 
  mutate(name = purrr::map_chr(content_guid, ~ content_title(client, .x, default_content_title))) %>% 
  dplyr::filter(name == Sys.getenv("APP_NAME")) %>% 
  {  ggplot(., aes(day, visits)) + 
     geom_bar(stat = "identity") +  
     labs(
       y = "# of Datapack sessions by day",
       x = "Date"
     )} 
```